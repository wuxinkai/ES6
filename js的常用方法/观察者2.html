<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>

<body>

</body>

</html>
<script>
  /**
   * 发布订阅模式(观察者模式)
   * handles: 事件处理函数集合
   * on: 订阅事件
   * emit: 发布事件
   * off: 删除事件
   **/

  class PubSub {
    constructor() {
      this.handles = {};
    }
    // 订阅事件
    on(eventType, handle) {
      if (!this.handles.hasOwnProperty(eventType)) {
        this.handles[eventType] = [];
      }
      if (typeof handle == 'function') {
        this.handles[eventType].push(handle);
      } else {
        throw new Error('缺少回调函数');
      }
      return this;
    }

    // 发布事件
    emit(eventType, ...args) {
      if (this.handles.hasOwnProperty(eventType)) {
        this.handles[eventType].forEach((item, key, arr) => {
          // 这是操作函数，给函数，改变this指向
          item.apply(null, args);
        })
      } else {
        throw new Error(`"${eventType}"事件未注册`);
      }
      return this;
    }

    // 删除事件
    off(eventType, handle) {
      if (!this.handles.hasOwnProperty(eventType)) {
        throw new Error(`"${eventType}"事件未注册`);
      } else if (typeof handle != 'function') {
        throw new Error('缺少回调函数');
      } else {

        this.handles[eventType].forEach((item, key, arr) => {
          if (item == handle) {
            arr.splice(key, 1);
          }
        })
      }
      return this; // 实现链式操作
    }
  }


  //看看当前回调函数是否相同如果相同删除，
  let callback = function (data = 3) {
    console.log('回调函数666');
  }



  let pubsub = new PubSub();

  pubsub.on('completed', (...args) => {
    console.log(1, args.join(''));
  }).on('completed', (data = 1) => {
    console.log('回调函数1');
  })

  pubsub.on('completed', (...args) => {
    console.log(2, args.join(''));
  }).on('completed', (data = 2) => {
    console.log('回调函数2');
  })

  //这个被删除的了
  pubsub.on('completed', (...args) => {
    console.log(3, args.join(''));
  }).on('completed', callback);

  console.log(`------------------------------------------`)

  pubsub.on('completed2', (...args) => {
    console.log(10001, args);
  }).on('completed2', (aaa = 1) => {
    console.log('回调函数2');
  })

  pubsub.on('completed2', (...args) => {
    console.log(10002, args);
  }).on('completed2', callback);


  pubsub.emit('completed', '这是', '发布的', '内容');
  pubsub.off('completed', callback); 

//删除的是回调函，不是当前监听的
  pubsub.emit('completed2', '会被', '删除的', '通过回调函数 两个函数', '是否相等删除');
  pubsub.off('completed2', callback); //看看当前回调函数是否相同如果相同删除，

  console.log(pubsub)
</script>